# .NET Desktop
# Build and run tests for .NET Desktop or Windows classic desktop solutions.
# Add steps that publish symbols, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/windows/dot-net

trigger:
  tags:
    include:
    - v*

pool:
  vmImage: 'windows-latest'

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  zipFileName: 'RetroScrap2000-Latest.zip'

stages:
- stage: BuildAndRelease
  displayName: 'Build, Zip und GitHub Release'
  jobs:
  - job: Release
    steps:
    # ðŸŒŸ NEU: Dieser Schritt muss die gesamte Historie abrufen (fetchDepth: 0) ðŸŒŸ
    - checkout: self
      fetchDepth: 0 
      
    # 1. .NET Projekt bauen
    - task: DotNetCoreCLI@2
      displayName: 'Build Project'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration)'

    # 2. Dateien zum Packen sammeln
    - task: CopyFiles@2
      displayName: 'Copy Files for Zipping'
      inputs:
        SourceFolder: '$(System.DefaultWorkingDirectory)'
        Contents: |
          **\bin\$(buildConfiguration)\**\*
        TargetFolder: '$(Build.ArtifactStagingDirectory)/App'
        
    # 3. Zip-Archiv der kompilierten Anwendung erstellen
    - task: ArchiveFiles@2
      displayName: 'Create Zip Archive'
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/App'
        includeRootFolder: false 
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(zipFileName)'
        replaceExistingArchive: true
    ## 4. Quelle (Source Code) nach GitHub pushen (nur der Tag)
    - bash: |
        # 1. Remote hinzufÃ¼gen
        git remote add github-release https://oauth2:$GitHubPAT@github.com/gruetze-software/RetroScrap-2000-Releases
        
        # 2. Den aktuellen Commit (HEAD) auf den Branch 'release-source' pushen.
        #    Dies stellt sicher, dass der Branch immer den Code des aktuellen Tags anzeigt.
        git push github-release HEAD:refs/heads/release-source
    
        # 3. Den Tag pushen (fÃ¼r den GitHub Release Task)
        git push github-release refs/tags/$(Build.SourceBranchName)
    
      displayName: 'Update Source Branch and Push Tag GitHub'
      env:
        GitHubPAT: $(GitHubCon)

    # 5. GitHub Release erstellen (mit Zip-Datei als Asset)
    - task: GitHubRelease@1
      displayName: 'Create GitHub Release'
      inputs:
        gitHubConnection: 'GitHubCon' # Name deiner Service Connection
        repositoryName: 'gruetze-software/RetroScrap-2000-Releases' 
        action: 'create'
        target: '$(Build.SourceVersion)' # Der Commit-Hash, auf dem das Tag sitzt
        tagSource: 'userSpecifiedTag'
        tag: '$(Build.SourceBranchName)' # Das Tag (z.B. v1.0)
        title: 'Release $(Build.SourceBranchName)'
        releaseNotesSource: 'inline'
        releaseNotesInline: 'Release Notes for Tag $(Build.SourceBranchName): $(Build.SourceVersionMessage)'
        assets: '$(Build.ArtifactStagingDirectory)/$(zipFileName)'
        isDraft: false
        isPrerelease: false